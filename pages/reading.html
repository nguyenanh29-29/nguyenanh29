<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán ƒê·ªçc - EAnh</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EAnh</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="reading.html" class="active">Luy·ªán ƒë·ªçc</a></li>
                        <li><a href="../backend/auth/logout.php">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
        <h1 style="margin-bottom: 2rem;">üì∞ Luy·ªán ƒê·ªçc</h1>

        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- Filter -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">C·∫•p ƒë·ªô</label>
                        <select class="form-control" id="levelFilter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="A1">A1 - C∆° b·∫£n</option>
                            <option value="A2">A2 - S∆° c·∫•p</option>
                            <option value="B1" selected>B1 - Trung c·∫•p</option>
                            <option value="B2">B2 - Trung cao</option>
                            <option value="C1">C1 - Cao c·∫•p</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="loadReadings()">T·∫£i b√†i ƒë·ªçc</button>
                    </div>
                </div>
            </div>

            <!-- Reading List -->
            <div id="readingList">
                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üì∞</div>
                    <h3 style="margin-bottom: 1rem;">Ch·ªçn c·∫•p ƒë·ªô ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
                    <p style="color: var(--text-gray);">R√®n luy·ªán k·ªπ nƒÉng ƒë·ªçc hi·ªÉu</p>
                </div>
            </div>

            <!-- Reading Content (hidden) -->
            <div id="readingContent" class="hidden">
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Passage -->
                    <div class="card">
                        <h2 class="card-title" id="readingTitle">Ti√™u ƒë·ªÅ</h2>
                        <div style="margin-top: 1rem; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 8px; max-height: 600px; overflow-y: auto; line-height: 1.8;" id="passageContent">
                        </div>
                    </div>

                    <!-- Questions -->
                    <div class="card">
                        <h3 class="card-title">C√¢u h·ªèi</h3>
                        <div id="questionsList" style="max-height: 600px; overflow-y: auto;">
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn btn-success" onclick="submitAnswers()">Ki·ªÉm tra</button>
                            <button class="btn btn-outline" onclick="backToList()">Quay l·∫°i</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentReading = null;
        let userAnswers = {};

        async function loadReadings() {
            const level = document.getElementById('levelFilter').value;
            try {
                const params = level ? `?level=${level}` : '';
                const response = await fetch(`../backend/api/reading.php${params}`);
                const data = await response.json();

                const container = document.getElementById('readingList');
                if (data.success && data.reading.length > 0) {
                    container.innerHTML = `
                        <div class="grid grid-3">
                            ${data.reading.map(item => `
                                <div class="card" style="cursor: pointer;" onclick="showReading(${item.id})">
                                    <div style="font-size: 3rem; margin-bottom: 1rem; text-align: center;">üìñ</div>
                                    <h3 class="card-title">${item.title}</h3>
                                    <p style="color: var(--text-gray); margin-bottom: 1rem;">C·∫•p ƒë·ªô: ${item.level}</p>
                                    <button class="btn btn-primary" style="width: 100%;">ƒê·ªçc ngay</button>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <p style="color: var(--text-gray);">Kh√¥ng c√≥ b√†i ƒë·ªçc n√†o</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading readings:', error);
            }
        }

        async function showReading(id) {
            try {
                const response = await fetch(`../backend/api/reading.php?id=${id}`);
                const data = await response.json();

                if (data.success) {
                    currentReading = data.reading;
                    
                    document.getElementById('readingTitle').textContent = data.reading.title;
                    document.getElementById('passageContent').innerHTML = data.reading.content.replace(/\n/g, '<br><br>');

                    loadQuestions(data.reading.questions);

                    document.getElementById('readingList').classList.add('hidden');
                    document.getElementById('readingContent').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading reading:', error);
            }
        }

        function loadQuestions(questionsJson) {
            try {
                const questions = JSON.parse(questionsJson || '[]');
                const container = document.getElementById('questionsList');

                if (questions.length > 0) {
                    container.innerHTML = questions.map((q, index) => `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <p style="margin-bottom: 1rem;"><strong>C√¢u ${index + 1}:</strong> ${q.question}</p>
                            ${q.options.map((opt, i) => `
                                <label style="display: block; padding: 0.75rem; cursor: pointer; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; transition: all 0.3s;">
                                    <input type="radio" name="question${index}" value="${i}" onchange="userAnswers[${index}] = ${i}" style="margin-right: 0.5rem;">
                                    ${opt}
                                </label>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-gray);">Kh√¥ng c√≥ c√¢u h·ªèi</p>';
                }
            } catch (error) {
                document.getElementById('questionsList').innerHTML = '<p style="color: var(--text-gray);">Kh√¥ng c√≥ c√¢u h·ªèi</p>';
            }
        }

        function submitAnswers() {
            try {
                const questions = JSON.parse(currentReading.questions || '[]');
                let correct = 0;
                let details = [];

                questions.forEach((q, index) => {
                    const isCorrect = userAnswers[index] === q.answer;
                    if (isCorrect) correct++;
                    
                    details.push({
                        question: index + 1,
                        correct: isCorrect,
                        userAnswer: userAnswers[index],
                        correctAnswer: q.answer
                    });
                });

                const score = (correct / questions.length * 100).toFixed(1);
                
                let message = `K·∫øt qu·∫£: ${correct}/${questions.length} c√¢u ƒë√∫ng (${score}%)\n\n`;
                details.forEach(d => {
                    message += `C√¢u ${d.question}: ${d.correct ? '‚úì ƒê√∫ng' : '‚úó Sai'}\n`;
                });

                alert(message);

                // Save progress
                saveReadingProgress(score);
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë√°p √°n');
            }
        }

        async function saveReadingProgress(score) {
            try {
                await fetch('../backend/api/reading.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reading_id: currentReading.id,
                        score: score,
                        completed: true
                    })
                });
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        function backToList() {
            document.getElementById('readingContent').classList.add('hidden');
            document.getElementById('readingList').classList.remove('hidden');
            userAnswers = {};
        }
    </script>
</body>
</html>