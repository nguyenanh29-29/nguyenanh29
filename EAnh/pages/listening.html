<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luy·ªán Nghe - EAnh</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EAnh</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="listening.html" class="active">Luy·ªán nghe</a></li>
                        <li><a href="../backend/auth/logout.php">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
        <h1 style="margin-bottom: 2rem;">üéß Luy·ªán Nghe</h1>

        <div style="max-width: 900px; margin: 0 auto;">
            <!-- Filter -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="grid grid-2">
                    <div class="form-group">
                        <label class="form-label">C·∫•p ƒë·ªô</label>
                        <select class="form-control" id="levelFilter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="A1">A1 - C∆° b·∫£n</option>
                            <option value="A2">A2 - S∆° c·∫•p</option>
                            <option value="B1" selected>B1 - Trung c·∫•p</option>
                            <option value="B2">B2 - Trung cao</option>
                            <option value="C1">C1 - Cao c·∫•p</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="loadListening()">T·∫£i b√†i nghe</button>
                    </div>
                </div>
            </div>

            <!-- Listening List -->
            <div class="grid grid-2" id="listeningList">
                <div class="card" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üéß</div>
                    <h3 style="margin-bottom: 1rem;">Ch·ªçn c·∫•p ƒë·ªô ƒë·ªÉ b·∫Øt ƒë·∫ßu</h3>
                    <p style="color: var(--text-gray);">Luy·ªán nghe v·ªõi nhi·ªÅu ch·ªß ƒë·ªÅ kh√°c nhau</p>
                </div>
            </div>

            <!-- Player Modal (hidden by default) -->
            <div id="playerModal" class="hidden">
                <div class="card">
                    <h2 class="card-title" id="audioTitle">Ti√™u ƒë·ªÅ</h2>
                    
                    <!-- Audio Player -->
                    <div style="background: rgba(0,0,0,0.2); padding: 2rem; border-radius: 8px; margin: 2rem 0;">
                        <audio id="audioPlayer" controls style="width: 100%;">
                            <source id="audioSource" src="" type="audio/mpeg">
                            Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
                        </audio>
                    </div>

                    <!-- Transcript Toggle -->
                    <button class="btn btn-outline" onclick="toggleTranscript()">
                        <span id="transcriptBtn">üìù Hi·ªán Script</span>
                    </button>

                    <div id="transcript" class="hidden" style="margin-top: 1rem; padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px; line-height: 1.8;">
                    </div>

                    <!-- Questions -->
                    <div id="questionsSection" style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem;">C√¢u h·ªèi:</h3>
                        <div id="questionsList"></div>
                        <button class="btn btn-success mt-2" onclick="submitAnswers()">Ki·ªÉm tra ƒë√°p √°n</button>
                    </div>

                    <button class="btn btn-primary mt-2" onclick="closePlayer()">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentListening = null;
        let userAnswers = {};

        async function loadListening() {
            const level = document.getElementById('levelFilter').value;
            try {
                const params = level ? `?level=${level}` : '';
                const response = await fetch(`../backend/api/listening.php${params}`);
                const data = await response.json();

                const container = document.getElementById('listeningList');
                if (data.success && data.listening.length > 0) {
                    container.innerHTML = data.listening.map(item => `
                        <div class="card" style="cursor: pointer;" onclick="playAudio(${item.id})">
                            <div style="font-size: 3rem; margin-bottom: 1rem; text-align: center;">üéß</div>
                            <h3 class="card-title">${item.title}</h3>
                            <p style="color: var(--text-gray); margin-bottom: 1rem;">C·∫•p ƒë·ªô: ${item.level}</p>
                            <button class="btn btn-primary" style="width: 100%;">Nghe ngay</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="card" style="text-align: center; padding: 3rem; grid-column: 1 / -1;">
                            <p style="color: var(--text-gray);">Kh√¥ng c√≥ b√†i nghe n√†o</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading listening:', error);
            }
        }

        async function playAudio(id) {
            try {
                const response = await fetch(`../backend/api/listening.php?id=${id}`);
                const data = await response.json();

                if (data.success) {
                    currentListening = data.listening;
                    
                    document.getElementById('audioTitle').textContent = data.listening.title;
                    
                    // Set audio source (demo URL)
                    const audioSource = document.getElementById('audioSource');
                    audioSource.src = data.listening.audio_url || 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
                    document.getElementById('audioPlayer').load();

                    // Set transcript
                    document.getElementById('transcript').innerHTML = data.listening.transcript || 'Kh√¥ng c√≥ script';

                    // Load questions
                    loadQuestions(data.listening.questions);

                    // Show player
                    document.getElementById('listeningList').classList.add('hidden');
                    document.getElementById('playerModal').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading audio:', error);
            }
        }

        function loadQuestions(questionsJson) {
            try {
                const questions = JSON.parse(questionsJson || '[]');
                const container = document.getElementById('questionsList');

                if (questions.length > 0) {
                    container.innerHTML = questions.map((q, index) => `
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <p style="margin-bottom: 1rem;"><strong>C√¢u ${index + 1}:</strong> ${q.question}</p>
                            ${q.options.map((opt, i) => `
                                <label style="display: block; padding: 0.5rem; cursor: pointer; margin-bottom: 0.5rem;">
                                    <input type="radio" name="question${index}" value="${i}" onchange="userAnswers[${index}] = ${i}">
                                    ${opt}
                                </label>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-gray);">Kh√¥ng c√≥ c√¢u h·ªèi</p>';
                }
            } catch (error) {
                document.getElementById('questionsList').innerHTML = '<p style="color: var(--text-gray);">Kh√¥ng c√≥ c√¢u h·ªèi</p>';
            }
        }

        function toggleTranscript() {
            const transcript = document.getElementById('transcript');
            const btn = document.getElementById('transcriptBtn');
            
            if (transcript.classList.contains('hidden')) {
                transcript.classList.remove('hidden');
                btn.textContent = 'üìù ·∫®n Script';
            } else {
                transcript.classList.add('hidden');
                btn.textContent = 'üìù Hi·ªán Script';
            }
        }

        function submitAnswers() {
            try {
                const questions = JSON.parse(currentListening.questions || '[]');
                let correct = 0;

                questions.forEach((q, index) => {
                    if (userAnswers[index] === q.answer) {
                        correct++;
                    }
                });

                const score = (correct / questions.length * 100).toFixed(1);
                alert(`B·∫°n tr·∫£ l·ªùi ƒë√∫ng ${correct}/${questions.length} c√¢u (${score}%)`);

                // Save progress
                saveListeningProgress(score);
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi ki·ªÉm tra ƒë√°p √°n');
            }
        }

        async function saveListeningProgress(score) {
            try {
                await fetch('../backend/api/listening.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        listening_id: currentListening.id,
                        score: score,
                        completed: true
                    })
                });
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        function closePlayer() {
            document.getElementById('playerModal').classList.add('hidden');
            document.getElementById('listeningList').classList.remove('hidden');
            document.getElementById('audioPlayer').pause();
            userAnswers = {};
        }
    </script>
</body>
</html>