<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªì S∆° - EAnh</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EAnh</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="profile.html" class="active">H·ªì s∆°</a></li>
                        <li><a href="../backend/auth/logout.php">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
        <h1 style="margin-bottom: 2rem;">üë§ H·ªì S∆° C√° Nh√¢n</h1>

        <div style="max-width: 900px; margin: 0 auto;">
            <div class="grid grid-2">
                <!-- Profile Info -->
                <div class="card">
                    <h3 class="card-title">Th√¥ng tin c√° nh√¢n</h3>
                    
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div id="avatarDisplay" style="width: 120px; height: 120px; margin: 0 auto 1rem; border-radius: 50%; background: linear-gradient(135deg, var(--primary), var(--accent)); display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white;">
                            üë§
                        </div>
                        <button class="btn btn-outline" onclick="document.getElementById('avatarInput').click()">
                            ƒê·ªïi ·∫£nh ƒë·∫°i di·ªán
                        </button>
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarChange(event)">
                    </div>

                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label">H·ªç v√† t√™n</label>
                            <input type="text" class="form-control" id="fullName" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" disabled>
                        </div>

                        <div class="form-group">
                            <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" class="form-control" id="phone" placeholder="0123456789">
                        </div>

                        <div class="form-group">
                            <label class="form-label">Ng√†y sinh</label>
                            <input type="date" class="form-control" id="birthdate">
                        </div>

                        <div class="form-group">
                            <label class="form-label">M·ª•c ti√™u h·ªçc t·∫≠p</label>
                            <select class="form-control" id="goal">
                                <option value="">Ch·ªçn m·ª•c ti√™u</option>
                                <option value="toeic">Luy·ªán thi TOEIC</option>
                                <option value="ielts">Luy·ªán thi IELTS</option>
                                <option value="toefl">Luy·ªán thi TOEFL</option>
                                <option value="general">Giao ti·∫øp t·ªïng qu√°t</option>
                                <option value="business">Ti·∫øng Anh th∆∞∆°ng m·∫°i</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            C·∫≠p nh·∫≠t th√¥ng tin
                        </button>
                    </form>
                </div>

                <!-- Settings & Security -->
                <div>
                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 class="card-title">B·∫£o m·∫≠t</h3>
                        
                        <div id="changePasswordForm" class="hidden">
                            <div class="form-group">
                                <label class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                                <input type="password" class="form-control" id="currentPassword">
                            </div>

                            <div class="form-group">
                                <label class="form-label">M·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" class="form-control" id="newPassword">
                            </div>

                            <div class="form-group">
                                <label class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                                <input type="password" class="form-control" id="confirmNewPassword">
                            </div>

                            <div style="display: flex; gap: 1rem;">
                                <button class="btn btn-primary" onclick="changePassword()">ƒê·ªïi m·∫≠t kh·∫©u</button>
                                <button class="btn btn-outline" onclick="togglePasswordForm()">H·ªßy</button>
                            </div>
                        </div>

                        <button id="showPasswordFormBtn" class="btn btn-outline" style="width: 100%;" onclick="togglePasswordForm()">
                            ƒê·ªïi m·∫≠t kh·∫©u
                        </button>
                    </div>

                    <div class="card" style="margin-bottom: 1rem;">
                        <h3 class="card-title">T√†i kho·∫£n ƒë√£ li√™n k·∫øt</h3>
                        <div id="linkedAccounts">
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">üìß</span>
                                    <div>
                                        <div style="font-weight: 600;">Email</div>
                                        <small style="color: var(--text-gray);" id="linkedEmail">-</small>
                                    </div>
                                </div>
                                <span style="color: var(--success);">‚úì ƒê√£ li√™n k·∫øt</span>
                            </div>

                            <div id="googleAccount" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <span style="font-size: 1.5rem;">üîµ</span>
                                    <div>
                                        <div style="font-weight: 600;">Google</div>
                                        <small style="color: var(--text-gray);">Ch∆∞a li√™n k·∫øt</small>
                                    </div>
                                </div>
                                <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Li√™n k·∫øt</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h3 class="card-title">C√†i ƒë·∫∑t</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <span>Nh·∫≠n th√¥ng b√°o qua email</span>
                                <input type="checkbox" id="emailNotifications" checked>
                            </label>
                        </div>

                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <span>√Çm thanh khi l√†m b√†i</span>
                                <input type="checkbox" id="soundEffects" checked>
                            </label>
                        </div>

                        <div>
                            <label style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                                <span>Ch·∫ø ƒë·ªô t·ªëi</span>
                                <input type="checkbox" id="darkMode" checked disabled>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="card" style="margin-top: 2rem; border: 1px solid var(--danger);">
                <h3 class="card-title" style="color: var(--danger);">V√πng nguy hi·ªÉm</h3>
                <p style="color: var(--text-gray); margin-bottom: 1rem;">
                    C√°c h√†nh ƒë·ªông d∆∞·ªõi ƒë√¢y kh√¥ng th·ªÉ ho√†n t√°c
                </p>
                <div style="display: flex; gap: 1rem;">
                    <button class="btn btn-outline" onclick="clearProgress()">
                        X√≥a to√†n b·ªô ti·∫øn ƒë·ªô
                    </button>
                    <button class="btn btn-danger" onclick="deleteAccount()">
                        X√≥a t√†i kho·∫£n
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadProfile() {
            try {
                const response = await fetch('../backend/api/profile.php');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('fullName').value = data.user.full_name || '';
                    document.getElementById('email').value = data.user.email || '';
                    document.getElementById('phone').value = data.user.phone || '';
                    document.getElementById('birthdate').value = data.user.birthdate || '';
                    document.getElementById('goal').value = data.user.goal || '';
                    document.getElementById('linkedEmail').textContent = data.user.email;

                    if (data.user.avatar) {
                        document.getElementById('avatarDisplay').innerHTML = `<img src="${data.user.avatar}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    }

                    if (data.user.google_id) {
                        document.getElementById('googleAccount').innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span style="font-size: 1.5rem;">üîµ</span>
                                <div>
                                    <div style="font-weight: 600;">Google</div>
                                    <small style="color: var(--text-gray);">ƒê√£ li√™n k·∫øt</small>
                                </div>
                            </div>
                            <span style="color: var(--success);">‚úì</span>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = {
                full_name: document.getElementById('fullName').value,
                phone: document.getElementById('phone').value,
                birthdate: document.getElementById('birthdate').value,
                goal: document.getElementById('goal').value
            };

            try {
                const response = await fetch('../backend/api/profile.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin');
            }
        });

        function handleAvatarChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('avatarDisplay').innerHTML = 
                        `<img src="${e.target.result}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                };
                reader.readAsDataURL(file);
                // In production, upload to server here
            }
        }

        function togglePasswordForm() {
            const form = document.getElementById('changePasswordForm');
            const btn = document.getElementById('showPasswordFormBtn');
            
            if (form.classList.contains('hidden')) {
                form.classList.remove('hidden');
                btn.classList.add('hidden');
            } else {
                form.classList.add('hidden');
                btn.classList.remove('hidden');
            }
        }

        async function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmNewPassword').value;

            if (!current || !newPass || !confirm) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }

            if (newPass !== confirm) {
                alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
                return;
            }

            try {
                const response = await fetch('../backend/api/change-password.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        current_password: current,
                        new_password: newPass
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
                    togglePasswordForm();
                    document.getElementById('currentPassword').value = '';
                    document.getElementById('newPassword').value = '';
                    document.getElementById('confirmNewPassword').value = '';
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi ƒë·ªïi m·∫≠t kh·∫©u');
            }
        }

        function clearProgress() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ti·∫øn ƒë·ªô h·ªçc t·∫≠p? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!')) {
                alert('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
            }
        }

        function deleteAccount() {
            if (confirm('B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën x√≥a t√†i kho·∫£n? T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!')) {
                if (confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi: X√≥a t√†i kho·∫£n?')) {
                    alert('Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
                }
            }
        }

        loadProfile();
    </script>
</body>
</html>