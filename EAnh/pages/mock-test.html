<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thi Th·ª≠ - EAnh</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EAnh</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="mock-test.html" class="active">Thi th·ª≠</a></li>
                        <li><a href="../backend/auth/logout.php">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
        <h1 style="margin-bottom: 2rem;">üìù Thi Th·ª≠</h1>

        <div style="max-width: 1000px; margin: 0 auto;">
            <!-- Test Selection -->
            <div id="testSelection">
                <div class="grid grid-2" style="margin-bottom: 2rem;">
                    <div class="card">
                        <div style="text-align: center; font-size: 4rem; margin-bottom: 1rem;">üìò</div>
                        <h3 class="card-title">TOEIC</h3>
                        <p style="color: var(--text-gray); margin-bottom: 1rem;">
                            Test of English for International Communication
                        </p>
                        <ul style="color: var(--text-gray); margin-bottom: 1rem; list-style: none; padding: 0;">
                            <li>‚è±Ô∏è Th·ªùi gian: 120 ph√∫t</li>
                            <li>üìä 200 c√¢u h·ªèi</li>
                            <li>üìà ƒêi·ªÉm: 10-990</li>
                        </ul>
                        <button class="btn btn-primary" style="width: 100%;" onclick="loadTests('TOEIC')">Ch·ªçn ƒë·ªÅ thi</button>
                    </div>

                    <div class="card">
                        <div style="text-align: center; font-size: 4rem; margin-bottom: 1rem;">üìó</div>
                        <h3 class="card-title">IELTS</h3>
                        <p style="color: var(--text-gray); margin-bottom: 1rem;">
                            International English Language Testing System
                        </p>
                        <ul style="color: var(--text-gray); margin-bottom: 1rem; list-style: none; padding: 0;">
                            <li>‚è±Ô∏è Th·ªùi gian: 165 ph√∫t</li>
                            <li>üìä 4 k·ªπ nƒÉng</li>
                            <li>üìà Band: 0-9</li>
                        </ul>
                        <button class="btn btn-primary" style="width: 100%;" onclick="loadTests('IELTS')">Ch·ªçn ƒë·ªÅ thi</button>
                    </div>
                </div>

                <!-- Test List -->
                <div id="testList" class="hidden">
                    <button class="btn btn-outline mb-2" onclick="backToSelection()">‚Üê Quay l·∫°i</button>
                    <div class="card">
                        <h3 class="card-title" id="testTypeTitle">Danh s√°ch ƒë·ªÅ thi</h3>
                        <div id="testItems">
                            <p style="color: var(--text-gray); text-align: center; padding: 2rem;">ƒêang t·∫£i...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test Taking -->
            <div id="testTaking" class="hidden">
                <div class="card" style="position: sticky; top: 80px; z-index: 10; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 class="card-title" id="testTitle" style="margin: 0;">ƒê·ªÅ thi</h3>
                        <div style="display: flex; gap: 2rem; align-items: center;">
                            <div>
                                <span style="color: var(--text-gray);">C√¢u h·ªèi:</span>
                                <strong id="questionProgress">0/0</strong>
                            </div>
                            <div>
                                <span style="color: var(--text-gray);">Th·ªùi gian:</span>
                                <strong id="timeRemaining" style="color: var(--warning);">00:00:00</strong>
                            </div>
                            <button class="btn btn-danger" onclick="submitTest()">N·ªôp b√†i</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div id="questionsContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTest = null;
        let userAnswers = {};
        let testTimer = null;
        let timeLeft = 0;

        async function loadTests(type) {
            try {
                const response = await fetch(`../backend/api/test.php?type=${type}`);
                const data = await response.json();

                document.getElementById('testSelection').style.display = 'none';
                document.getElementById('testList').classList.remove('hidden');
                document.getElementById('testTypeTitle').textContent = `ƒê·ªÅ thi ${type}`;

                const container = document.getElementById('testItems');
                if (data.success && data.tests.length > 0) {
                    container.innerHTML = data.tests.map(test => `
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.3s;" 
                             onmouseover="this.style.background='rgba(99,102,241,0.1)'" 
                             onmouseout="this.style.background='transparent'"
                             onclick="startTest(${test.id})">
                            <h4 style="margin-bottom: 0.5rem; color: var(--primary);">${test.title}</h4>
                            <div style="color: var(--text-gray); font-size: 0.9rem;">
                                <span>‚è±Ô∏è ${test.duration} ph√∫t</span>
                                <span style="margin-left: 1rem;">üìä C·∫•p ƒë·ªô: ${test.level}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-gray); text-align: center; padding: 2rem;">Kh√¥ng c√≥ ƒë·ªÅ thi</p>';
                }
            } catch (error) {
                console.error('Error loading tests:', error);
            }
        }

        function backToSelection() {
            document.getElementById('testList').classList.add('hidden');
            document.getElementById('testSelection').style.display = 'block';
        }

        async function startTest(testId) {
            try {
                const response = await fetch(`../backend/api/test.php?id=${testId}`);
                const data = await response.json();

                if (data.success) {
                    currentTest = data.test;
                    userAnswers = {};

                    document.getElementById('testList').classList.add('hidden');
                    document.getElementById('testTaking').classList.remove('hidden');

                    document.getElementById('testTitle').textContent = data.test.title;

                    // Load questions
                    loadTestQuestions(data.test.questions);

                    // Start timer
                    timeLeft = data.test.duration * 60;
                    startTimer();
                }
            } catch (error) {
                console.error('Error starting test:', error);
            }
        }

        function loadTestQuestions(questionsJson) {
            try {
                const questions = JSON.parse(questionsJson || '[]');
                const container = document.getElementById('questionsContainer');

                document.getElementById('questionProgress').textContent = `0/${questions.length}`;

                if (questions.length > 0) {
                    container.innerHTML = questions.map((q, index) => `
                        <div style="margin-bottom: 2rem; padding: 1.5rem; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <p style="margin-bottom: 1rem; font-weight: 600;">
                                <span style="color: var(--primary);">C√¢u ${index + 1}:</span> ${q.question}
                            </p>
                            ${q.options.map((opt, i) => `
                                <label style="display: block; padding: 1rem; cursor: pointer; margin-bottom: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px; transition: all 0.3s;"
                                       onmouseover="this.style.background='rgba(99,102,241,0.1)'"
                                       onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                    <input type="radio" name="question${index}" value="${i}" 
                                           onchange="userAnswers[${index}] = ${i}; updateProgress()" 
                                           style="margin-right: 0.5rem;">
                                    ${opt}
                                </label>
                            `).join('')}
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-gray);">Kh√¥ng c√≥ c√¢u h·ªèi</p>';
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        function updateProgress() {
            const questions = JSON.parse(currentTest.questions || '[]');
            const answered = Object.keys(userAnswers).length;
            document.getElementById('questionProgress').textContent = `${answered}/${questions.length}`;
        }

        function startTimer() {
            testTimer = setInterval(() => {
                timeLeft--;

                const hours = Math.floor(timeLeft / 3600);
                const minutes = Math.floor((timeLeft % 3600) / 60);
                const seconds = timeLeft % 60;

                document.getElementById('timeRemaining').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(testTimer);
                    alert('H·∫øt gi·ªù!');
                    submitTest();
                }
            }, 1000);
        }

        async function submitTest() {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i?')) return;

            clearInterval(testTimer);

            try {
                const questions = JSON.parse(currentTest.questions || '[]');
                let correct = 0;

                questions.forEach((q, index) => {
                    if (userAnswers[index] === q.answer) {
                        correct++;
                    }
                });

                const score = (correct / questions.length * 100).toFixed(1);
                const timeSpent = (currentTest.duration * 60) - timeLeft;

                // Save result
                const response = await fetch('../backend/api/test.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        test_id: currentTest.id,
                        score: score,
                        answers: JSON.stringify(userAnswers),
                        time_spent: timeSpent
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert(`Ho√†n th√†nh!\nƒêi·ªÉm: ${score}%\nS·ªë c√¢u ƒë√∫ng: ${correct}/${questions.length}`);
                    window.location.href = 'result.html';
                }
            } catch (error) {
                alert('C√≥ l·ªói x·∫£y ra khi n·ªôp b√†i');
            }
        }
    </script>
</body>
</html>