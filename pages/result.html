<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt Qu·∫£ - EAnh</title>
    <link rel="stylesheet" href="../assets/css/style.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">EAnh</div>
                <nav>
                    <ul class="nav-menu">
                        <li><a href="../dashboard.html">Dashboard</a></li>
                        <li><a href="result.html" class="active">K·∫øt qu·∫£</a></li>
                        <li><a href="../backend/auth/logout.php">ƒêƒÉng xu·∫•t</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container" style="margin-top: 2rem; margin-bottom: 2rem;">
        <h1 style="margin-bottom: 2rem;">üìä K·∫øt Qu·∫£ & Th·ªëng K√™</h1>

        <div style="max-width: 1200px; margin: 0 auto;">
            <!-- Overall Stats -->
            <div class="stats-grid" style="margin-bottom: 2rem;">
                <div class="stat-card">
                    <div class="stat-value" id="totalTests">0</div>
                    <div class="stat-label">B√†i thi ƒë√£ l√†m</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #10b981, #059669);">
                    <div class="stat-value" id="avgScore">0%</div>
                    <div class="stat-label">ƒêi·ªÉm trung b√¨nh</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                    <div class="stat-value" id="highestScore">0%</div>
                    <div class="stat-label">ƒêi·ªÉm cao nh·∫•t</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                    <div class="stat-value" id="totalTime">0h</div>
                    <div class="stat-label">T·ªïng th·ªùi gian h·ªçc</div>
                </div>
            </div>

            <!-- Filter -->
            <div class="card" style="margin-bottom: 2rem;">
                <div class="grid grid-3">
                    <div class="form-group">
                        <label class="form-label">Lo·∫°i b√†i thi</label>
                        <select class="form-control" id="testTypeFilter">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="vocabulary">T·ª´ v·ª±ng</option>
                            <option value="grammar">Ng·ªØ ph√°p</option>
                            <option value="listening">Nghe</option>
                            <option value="reading">ƒê·ªçc</option>
                            <option value="test">Thi th·ª≠</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Th·ªùi gian</label>
                        <select class="form-control" id="timeFilter">
                            <option value="7">7 ng√†y qua</option>
                            <option value="30" selected>30 ng√†y qua</option>
                            <option value="90">90 ng√†y qua</option>
                            <option value="all">T·∫•t c·∫£</option>
                        </select>
                    </div>
                    <div style="display: flex; align-items: flex-end;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="loadResults()">L·ªçc k·∫øt qu·∫£</button>
                    </div>
                </div>
            </div>

            <!-- Results Table -->
            <div class="card">
                <h3 class="card-title">L·ªãch s·ª≠ l√†m b√†i</h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border);">
                                <th style="padding: 1rem; text-align: left;">Ng√†y</th>
                                <th style="padding: 1rem; text-align: left;">Lo·∫°i b√†i</th>
                                <th style="padding: 1rem; text-align: left;">T√™n b√†i</th>
                                <th style="padding: 1rem; text-align: center;">ƒêi·ªÉm</th>
                                <th style="padding: 1rem; text-align: center;">Th·ªùi gian</th>
                                <th style="padding: 1rem; text-align: center;">Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTable">
                            <tr>
                                <td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-gray);">
                                    ƒêang t·∫£i d·ªØ li·ªáu...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Progress Chart -->
            <div class="grid grid-2" style="margin-top: 2rem;">
                <div class="card">
                    <h3 class="card-title">Ti·∫øn ƒë·ªô theo th·ªùi gian</h3>
                    <canvas id="progressChart" height="200"></canvas>
                </div>

                <div class="card">
                    <h3 class="card-title">Ph√¢n b·ªë ƒëi·ªÉm s·ªë</h3>
                    <canvas id="scoreChart" height="200"></canvas>
                </div>
            </div>

            <!-- Detailed Analysis -->
            <div class="card" style="margin-top: 2rem;">
                <h3 class="card-title">Ph√¢n t√≠ch chi ti·∫øt</h3>
                <div id="detailedAnalysis" class="grid grid-2">
                    <div style="padding: 1.5rem; background: rgba(99, 102, 241, 0.1); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: var(--primary);">ƒêi·ªÉm m·∫°nh</h4>
                        <ul id="strengthsList" style="list-style: none; padding: 0; color: var(--text-gray);">
                            <li style="padding: 0.5rem 0;">üìà ƒêang ph√¢n t√≠ch...</li>
                        </ul>
                    </div>
                    <div style="padding: 1.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                        <h4 style="margin-bottom: 1rem; color: var(--danger);">C·∫ßn c·∫£i thi·ªán</h4>
                        <ul id="weaknessesList" style="list-style: none; padding: 0; color: var(--text-gray);">
                            <li style="padding: 0.5rem 0;">üìâ ƒêang ph√¢n t√≠ch...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadResults() {
            try {
                const testType = document.getElementById('testTypeFilter').value;
                const timeRange = document.getElementById('timeFilter').value;

                const params = new URLSearchParams();
                if (testType) params.append('type', testType);
                if (timeRange !== 'all') params.append('days', timeRange);

                const response = await fetch(`../backend/api/result.php?${params}`);
                const data = await response.json();

                if (data.success) {
                    updateStats(data.stats);
                    updateResultsTable(data.results);
                    updateAnalysis(data.analysis);
                }
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        function updateStats(stats) {
            document.getElementById('totalTests').textContent = stats.total_tests || 0;
            document.getElementById('avgScore').textContent = (stats.avg_score || 0) + '%';
            document.getElementById('highestScore').textContent = (stats.highest_score || 0) + '%';
            
            const hours = Math.floor((stats.total_time || 0) / 3600);
            document.getElementById('totalTime').textContent = hours + 'h';
        }

        function updateResultsTable(results) {
            const tbody = document.getElementById('resultsTable');
            
            if (results && results.length > 0) {
                tbody.innerHTML = results.map(result => {
                    const scoreClass = result.score >= 80 ? 'success' : result.score >= 60 ? 'warning' : 'danger';
                    return `
                        <tr style="border-bottom: 1px solid var(--border);">
                            <td style="padding: 1rem;">${new Date(result.completed_at).toLocaleDateString('vi-VN')}</td>
                            <td style="padding: 1rem;">
                                <span style="padding: 0.25rem 0.75rem; background: var(--primary); border-radius: 4px; font-size: 0.85rem;">
                                    ${result.activity_type}
                                </span>
                            </td>
                            <td style="padding: 1rem;">${result.test_name || 'B√†i t·∫≠p'}</td>
                            <td style="padding: 1rem; text-align: center;">
                                <span style="padding: 0.5rem 1rem; background: var(--${scoreClass}); border-radius: 4px; font-weight: 600;">
                                    ${result.score}%
                                </span>
                            </td>
                            <td style="padding: 1rem; text-align: center; color: var(--text-gray);">
                                ${Math.floor(result.time_spent / 60)}m ${result.time_spent % 60}s
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.85rem;" onclick="viewDetail(${result.id})">
                                    Xem chi ti·∫øt
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 2rem; text-align: center; color: var(--text-gray);">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o</td></tr>';
            }
        }

        function updateAnalysis(analysis) {
            if (!analysis) return;

            // Strengths
            const strengthsList = document.getElementById('strengthsList');
            if (analysis.strengths && analysis.strengths.length > 0) {
                strengthsList.innerHTML = analysis.strengths.map(s => 
                    `<li style="padding: 0.5rem 0;">‚úì ${s}</li>`
                ).join('');
            } else {
                strengthsList.innerHTML = '<li style="padding: 0.5rem 0;">Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch</li>';
            }

            // Weaknesses
            const weaknessesList = document.getElementById('weaknessesList');
            if (analysis.weaknesses && analysis.weaknesses.length > 0) {
                weaknessesList.innerHTML = analysis.weaknesses.map(w => 
                    `<li style="padding: 0.5rem 0;">‚Üí ${w}</li>`
                ).join('');
            } else {
                weaknessesList.innerHTML = '<li style="padding: 0.5rem 0;">Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch</li>';
            }
        }

        function viewDetail(resultId) {
            alert(`Xem chi ti·∫øt k·∫øt qu·∫£ #${resultId} - Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn`);
        }

        // Placeholder for charts
        function initCharts() {
            const ctx1 = document.getElementById('progressChart');
            const ctx2 = document.getElementById('scoreChart');
            
            if (ctx1) {
                ctx1.getContext('2d').fillText('Bi·ªÉu ƒë·ªì ti·∫øn ƒë·ªô', 10, 50);
            }
            if (ctx2) {
                ctx2.getContext('2d').fillText('Bi·ªÉu ƒë·ªì ph√¢n b·ªë ƒëi·ªÉm', 10, 50);
            }
        }

        loadResults();
        initCharts();
    </script>
</body>
</html>